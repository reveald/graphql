# Precompiled Query Example

This example demonstrates how to use **precompiled queries** with auto-generated GraphQL schemas.

## What are Precompiled Queries?

Precompiled queries allow you to define complex Elasticsearch queries as Go functions and automatically generate strongly-typed GraphQL schemas from them. This is ideal for:

- Complex aggregation queries
- Reports and dashboards
- Pre-defined analytics queries
- Queries with specific business logic

## Key Features

- ✅ **Auto-generated GraphQL schema** from ES query structure
- ✅ **No ES execution during startup** - pure static analysis of query definition
- ✅ **Strongly-typed aggregation results**
- ✅ **Parameterized queries** (e.g., market filter)
- ✅ **Complex nested aggregations** fully supported

## How It Works

1. Define a `QueryBuilder` function that builds an Elasticsearch search request
2. Register it with `config.AddPrecompiledQuery()`
3. The system analyzes the aggregation structure and generates GraphQL types
4. GraphQL schema is automatically created with proper typing

## Example

```go
config.AddPrecompiledQuery("leadsOverview", &revealdgraphql.PrecompiledQueryConfig{
    Index:       "leads",
    Description: "Leads overview with statistics",
    QueryBuilder: buildLeadsOverviewQuery,
    Parameters: graphql.FieldConfigArgument{
        "market": &graphql.ArgumentConfig{
            Type: graphql.NewList(graphql.String),
        },
    },
})

func buildLeadsOverviewQuery(args map[string]any) *search.Request {
    // Build complex ES query with aggregations
    // Extract parameters from args
    // Return *search.Request
}
```

## Running the Example

```bash
cd examples/precompiled
go run main.go
```

Then open http://localhost:8080/graphql in your browser.

## Example GraphQL Query

```graphql
query {
  leadsOverview(market: ["SE", "NO"]) {
    totalCount
    aggregations {
      by_leadType {
        value
        count
        by_mechanism {
          value
          count
          periods {
            last_24h { count }
            prev_24h { count }
            last_7d { count }
          }
          last_30d_daily {
            count
            per_day {
              date
              count
            }
          }
        }
      }
    }
  }
}
```

## Schema Generation

The GraphQL schema is automatically generated by analyzing the aggregation structure:

- **Terms aggregations** → Array of buckets with `value` and `count`
- **Filters aggregations** → Object with named fields (one per filter)
- **Date histogram** → Array of buckets with `date` and `count`
- **Filter (singular)** → Wrapper object with sub-aggregations
- **Nested aggregations** → Recursively generated types

## Benefits

- **Type Safety**: GraphQL types match the actual ES response structure
- **No Manual Schema Writing**: Schema is generated automatically
- **Flexibility**: Full control over ES query construction
- **Performance**: No ES execution during schema generation
